{% extends 'base.html' %}

{% block title %}Traitement Emails - OrderFlow Pro{% endblock %}
{% block page_title %}Traitement des Emails{% endblock %}
{% block breadcrumb %}<span class="mx-2">/</span><span>Emails</span>{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Info Card -->
    <div class="card p-6 bg-gradient-to-r from-brand-50 to-blue-50 border-brand-200">
        <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-brand-500 rounded-xl flex items-center justify-center flex-shrink-0">
                <i class="fas fa-robot text-white text-xl"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-bold text-slate-800 mb-1">Extraction Intelligente par IA</h3>
                <p class="text-slate-600 text-sm">Notre syst√®me analyse automatiquement vos emails et pi√®ces jointes (PDF, images, audio) pour extraire les informations des bons de commande gr√¢ce √† GPT-4o Vision.</p>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Panel -->
        <div class="lg:col-span-2 card">
            <div class="p-6 border-b border-slate-100">
                <h3 class="font-bold text-slate-800 text-lg">Lancer le traitement</h3>
                <p class="text-slate-500 text-sm mt-1">Scannez votre bo√Æte de r√©ception pour d√©tecter les nouveaux bons de commande</p>
            </div>
            <div class="p-6">
                <div id="processPanel" class="text-center py-8">
                    <div class="w-20 h-20 bg-brand-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-envelope-open-text text-brand-600 text-3xl"></i>
                    </div>
                    <h4 class="font-semibold text-slate-800 mb-2">Pr√™t √† analyser</h4>
                    <p class="text-slate-500 text-sm mb-6">Cliquez sur le bouton ci-dessous pour scanner les nouveaux emails</p>
                    <button onclick="processEmails()" class="btn-primary text-lg px-8 py-3">
                        <i class="fas fa-play"></i>
                        D√©marrer le traitement
                    </button>
                </div>

                <div id="processingPanel" class="hidden py-8">
                    <div class="text-center">
                        <div class="w-20 h-20 bg-brand-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                            <i class="fas fa-cog text-brand-600 text-3xl animate-spin"></i>
                        </div>
                        <h4 class="font-semibold text-slate-800 mb-2">Traitement en cours...</h4>
                        <p class="text-slate-500 text-sm" id="processingStatus">Connexion √† la bo√Æte mail...</p>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="mt-6 max-w-md mx-auto">
                        <div class="flex justify-between text-sm text-slate-600 mb-2">
                            <span id="progressLabel">Initialisation...</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="w-full h-3 bg-slate-200 rounded-full overflow-hidden">
                            <div id="progressBar" class="h-full bg-gradient-to-r from-brand-500 to-blue-500 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <!-- Steps -->
                    <div class="mt-6 max-w-lg mx-auto">
                        <div class="flex justify-between">
                            <div class="flex flex-col items-center" id="step1">
                                <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 transition-all duration-300">
                                    <i class="fas fa-plug"></i>
                                </div>
                                <span class="text-xs mt-2 text-slate-400">Connexion</span>
                            </div>
                            <div class="flex-1 flex items-center px-2">
                                <div class="h-1 w-full bg-slate-200 rounded" id="line1"></div>
                            </div>
                            <div class="flex flex-col items-center" id="step2">
                                <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 transition-all duration-300">
                                    <i class="fas fa-search"></i>
                                </div>
                                <span class="text-xs mt-2 text-slate-400">Scan emails</span>
                            </div>
                            <div class="flex-1 flex items-center px-2">
                                <div class="h-1 w-full bg-slate-200 rounded" id="line2"></div>
                            </div>
                            <div class="flex flex-col items-center" id="step3">
                                <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 transition-all duration-300">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <span class="text-xs mt-2 text-slate-400">Analyse IA</span>
                            </div>
                            <div class="flex-1 flex items-center px-2">
                                <div class="h-1 w-full bg-slate-200 rounded" id="line3"></div>
                            </div>
                            <div class="flex flex-col items-center" id="step4">
                                <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 transition-all duration-300">
                                    <i class="fas fa-database"></i>
                                </div>
                                <span class="text-xs mt-2 text-slate-400">Sauvegarde</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Log Panel -->
                    <div class="mt-6 bg-slate-900 rounded-lg p-4 max-h-48 overflow-y-auto" id="logContainer">
                        <pre id="processLog" class="text-green-400 text-xs font-mono"></pre>
                    </div>
                </div>

                <div id="resultPanel" class="hidden py-8">
                    <div class="text-center" id="resultContent"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Status -->
            <div class="card p-5">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-server text-brand-500"></i>
                    Statut du syst√®me
                </h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <span class="text-sm text-slate-600">Connexion Gmail</span>
                        <span class="flex items-center text-emerald-600 text-xs font-medium">
                            <span class="w-2 h-2 bg-emerald-500 rounded-full mr-1.5"></span>Connect√©
                        </span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <span class="text-sm text-slate-600">OpenAI API</span>
                        <span class="flex items-center text-emerald-600 text-xs font-medium">
                            <span class="w-2 h-2 bg-emerald-500 rounded-full mr-1.5"></span>Actif
                        </span>
                    </div>
                </div>
            </div>

            <!-- Capabilities -->
            <div class="card p-5">
                <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-magic text-brand-500"></i>
                    Capacit√©s IA
                </h3>
                <div class="space-y-3 text-sm">
                    <div class="flex items-center gap-3 text-slate-600">
                        <i class="fas fa-file-pdf text-red-500 w-5"></i>
                        <span>Extraction PDF</span>
                    </div>
                    <div class="flex items-center gap-3 text-slate-600">
                        <i class="fas fa-image text-blue-500 w-5"></i>
                        <span>Analyse d'images (Vision)</span>
                    </div>
                    <div class="flex items-center gap-3 text-slate-600">
                        <i class="fas fa-microphone text-purple-500 w-5"></i>
                        <span>Transcription audio (Whisper)</span>
                    </div>
                    <div class="flex items-center gap-3 text-slate-600">
                        <i class="fas fa-redo text-amber-500 w-5"></i>
                        <span>D√©tection de relances</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let progressInterval;
let currentProgress = 0;

function updateProgress(percent, label, step) {
    document.getElementById('progressBar').style.width = percent + '%';
    document.getElementById('progressPercent').textContent = percent + '%';
    document.getElementById('progressLabel').textContent = label;
    document.getElementById('processingStatus').textContent = label;
    
    // Update steps
    for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById('step' + i);
        const lineEl = document.getElementById('line' + i);
        const circle = stepEl.querySelector('div');
        const text = stepEl.querySelector('span');
        
        if (i < step) {
            // Completed
            circle.className = 'w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center text-white transition-all duration-300';
            text.className = 'text-xs mt-2 text-emerald-600 font-medium';
            if (lineEl) lineEl.className = 'h-1 w-full bg-emerald-500 rounded transition-all duration-300';
        } else if (i === step) {
            // Active
            circle.className = 'w-10 h-10 rounded-full bg-brand-500 flex items-center justify-center text-white transition-all duration-300 animate-pulse';
            text.className = 'text-xs mt-2 text-brand-600 font-medium';
        } else {
            // Pending
            circle.className = 'w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 transition-all duration-300';
            text.className = 'text-xs mt-2 text-slate-400';
        }
    }
}

function addLog(message, type = 'info') {
    const log = document.getElementById('processLog');
    const timestamp = new Date().toLocaleTimeString();
    const colors = {
        'info': 'text-blue-400',
        'success': 'text-green-400',
        'warning': 'text-yellow-400',
        'error': 'text-red-400',
        'process': 'text-cyan-400'
    };
    const color = colors[type] || 'text-green-400';
    log.innerHTML += `<span class="text-slate-500">[${timestamp}]</span> <span class="${color}">${message}</span>\n`;
    document.getElementById('logContainer').scrollTop = document.getElementById('logContainer').scrollHeight;
}

let waitingInterval;
let waitingSeconds = 0;

function simulateProgress() {
    const steps = [
        { percent: 5, label: 'Connexion √† Gmail...', step: 1, delay: 500 },
        { percent: 15, label: 'Authentification r√©ussie', step: 1, delay: 800, log: '‚úì Connexion Gmail √©tablie', logType: 'success' },
        { percent: 25, label: 'Recherche des emails...', step: 2, delay: 600, log: '‚Üí Scan de la bo√Æte de r√©ception...', logType: 'process' },
        { percent: 35, label: 'Analyse des sujets...', step: 2, delay: 700, log: '‚Üí Filtrage des emails pertinents...', logType: 'process' },
        { percent: 45, label: 'T√©l√©chargement des pi√®ces jointes...', step: 2, delay: 900, log: '‚Üí T√©l√©chargement des pi√®ces jointes...', logType: 'process' },
        { percent: 55, label: 'Extraction IA en cours...', step: 3, delay: 1000, log: 'ü§ñ Analyse GPT-4o Vision initi√©e', logType: 'info' },
        { percent: 65, label: 'Analyse des documents...', step: 3, delay: 1200, log: '‚Üí Extraction des informations...', logType: 'process' },
        { percent: 75, label: 'Validation des donn√©es...', step: 3, delay: 800, log: '‚Üí Validation des donn√©es extraites...', logType: 'process' },
        { percent: 85, label: 'Enregistrement en base...', step: 4, delay: 600, log: 'üíæ Sauvegarde en base de donn√©es...', logType: 'info' },
        { percent: 90, label: 'Traitement IA en cours...', step: 4, delay: 400, log: '‚Üí L\'analyse peut prendre quelques minutes...', logType: 'info' }
    ];
    
    let stepIndex = 0;
    
    function nextStep() {
        if (stepIndex < steps.length) {
            const s = steps[stepIndex];
            updateProgress(s.percent, s.label, s.step);
            if (s.log) addLog(s.log, s.logType);
            stepIndex++;
            setTimeout(nextStep, s.delay);
        } else {
            // Start waiting animation after reaching 90%
            waitingSeconds = 0;
            waitingInterval = setInterval(() => {
                waitingSeconds++;
                const dots = '.'.repeat((waitingSeconds % 3) + 1);
                document.getElementById('processingStatus').textContent = `Analyse IA en cours${dots} (${waitingSeconds}s)`;
                document.getElementById('progressLabel').textContent = `Analyse IA en cours${dots} (${waitingSeconds}s)`;
                
                // Slowly increment progress from 90% to 95%
                const currentPercent = Math.min(90 + Math.floor(waitingSeconds / 10), 95);
                document.getElementById('progressBar').style.width = currentPercent + '%';
                document.getElementById('progressPercent').textContent = currentPercent + '%';
            }, 1000);
        }
    }
    
    nextStep();
}

function processEmails() {
    document.getElementById('processPanel').classList.add('hidden');
    document.getElementById('processingPanel').classList.remove('hidden');
    document.getElementById('resultPanel').classList.add('hidden');
    document.getElementById('processLog').textContent = '';
    
    // Reset progress
    updateProgress(0, 'Initialisation...', 1);
    addLog('D√©marrage du traitement...', 'info');
    
    // Start progress simulation
    simulateProgress();

    fetch('/api/process-emails', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            // Stop waiting animation
            if (waitingInterval) {
                clearInterval(waitingInterval);
                waitingInterval = null;
            }
            
            // Complete progress
            updateProgress(100, 'Termin√© !', 5);
            addLog('‚úì Traitement termin√© avec succ√®s', 'success');
            
            setTimeout(() => {
                document.getElementById('processingPanel').classList.add('hidden');
                document.getElementById('resultPanel').classList.remove('hidden');
                
                const resultContent = document.getElementById('resultContent');
                if (data.success) {
                    resultContent.innerHTML = `
                        <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check text-emerald-600 text-3xl"></i>
                        </div>
                        <h4 class="font-semibold text-slate-800 mb-2">Traitement termin√© !</h4>
                        <p class="text-slate-600 mb-6">${data.orders_count} commande(s) d√©tect√©e(s)</p>
                        <div class="flex justify-center gap-3">
                            <a href="/orders" class="btn-primary"><i class="fas fa-list"></i>Voir les commandes</a>
                            <button onclick="resetProcess()" class="btn-secondary"><i class="fas fa-redo"></i>Relancer</button>
                        </div>
                    `;
                } else {
                    resultContent.innerHTML = `
                        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-times text-red-600 text-3xl"></i>
                        </div>
                        <h4 class="font-semibold text-slate-800 mb-2">Erreur</h4>
                        <p class="text-red-600 mb-6">${data.error || 'Une erreur est survenue'}</p>
                        <button onclick="resetProcess()" class="btn-secondary"><i class="fas fa-redo"></i>R√©essayer</button>
                    `;
                }
            }, 800);
        })
        .catch(error => {
            // Stop waiting animation
            if (waitingInterval) {
                clearInterval(waitingInterval);
                waitingInterval = null;
            }
            
            addLog('‚úó Erreur: ' + error.message, 'error');
            setTimeout(() => {
                document.getElementById('processingPanel').classList.add('hidden');
                document.getElementById('resultPanel').classList.remove('hidden');
                document.getElementById('resultContent').innerHTML = `
                    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-times text-red-600 text-3xl"></i>
                    </div>
                    <h4 class="font-semibold text-slate-800 mb-2">Erreur de connexion</h4>
                    <p class="text-red-600 mb-6">${error.message}</p>
                    <button onclick="resetProcess()" class="btn-secondary"><i class="fas fa-redo"></i>R√©essayer</button>
                `;
            }, 500);
        });
}

function resetProcess() {
    // Stop any running interval
    if (waitingInterval) {
        clearInterval(waitingInterval);
        waitingInterval = null;
    }
    waitingSeconds = 0;
    
    document.getElementById('processPanel').classList.remove('hidden');
    document.getElementById('processingPanel').classList.add('hidden');
    document.getElementById('resultPanel').classList.add('hidden');
    // Reset steps visually
    for (let i = 1; i <= 4; i++) {
        const stepEl = document.getElementById('step' + i);
        const lineEl = document.getElementById('line' + i);
        stepEl.querySelector('div').className = 'w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-400 transition-all duration-300';
        stepEl.querySelector('span').className = 'text-xs mt-2 text-slate-400';
        if (lineEl) lineEl.className = 'h-1 w-full bg-slate-200 rounded';
    }
}
</script>
{% endblock %}
